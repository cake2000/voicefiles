The main logic goes like this.