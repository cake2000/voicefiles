This is the full logic.