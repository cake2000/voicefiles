The majority of this function is the forloop,